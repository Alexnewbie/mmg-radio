<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AzuraCast Radio Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #A30000;
        }
        .player-card {
            background-color: #A30000;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .play-button-wrapper {
            background: white;
            border-radius: 50%;
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s ease-in-out, background-color 0.2s;
        }
        .play-button-wrapper:hover:not(:disabled) {
            transform: scale(1.1);
        }
        .play-button-wrapper:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: scale(1);
        }
        .play-icon, .pause-icon {
            color: #A30000;
        }
        #albumArt {
            min-height: 250px;
        }
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            margin-top: -5px;
            background-color: #fff;
            height: 16px;
            width: 16px;
            border-radius: 50%;
        }
        @keyframes animStar {
          from { transform: translateY(0px); }
          to { transform: translateY(-2000px); }
        }
        .stars-bg {
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            overflow: hidden;
        }
        .stars {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; display: block;
        }

        /* Advertisement badge */
        .ad-badge {
            display: inline-block;
            background-color: #FFD700;
            color: #A30000;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 6px;
            margin-left: 8px;
            border-radius: 6px;
            vertical-align: middle;
            text-transform: uppercase;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Offline Mode Screen -->
    <div id="offline-container" class="fixed inset-0 z-40 hidden">
        <div class="absolute inset-0 stars-bg">
            <div id="stars1"></div>
            <div id="stars2"></div>
            <div id="stars3"></div>
        </div>
        <div class="relative z-10 flex flex-col items-center justify-center h-full text-white">
            <h2 class="text-4xl md:text-5xl font-black uppercase">Radio Offline</h2>
            <p class="text-lg md:text-xl text-white/70 mt-2">Could not connect to the stream.</p>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Setup Your Radio Player</h2>
            <p class="mb-6 text-gray-600">Configuration is pre-filled. Just hit start!</p>
            <div>
                <label for="azuraUrl" class="block text-sm font-medium text-gray-700">AzuraCast URL</label>
                <input type="text" id="azuraUrl" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., https://your-radio.com">
                 <p class="mt-2 text-xs text-gray-500">This is the main URL for your AzuraCast instance.</p>
            </div>
             <div class="mt-4">
                <label for="stationId" class="block text-sm font-medium text-gray-700">Station Shortcode or ID</label>
                <input type="text" id="stationId" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., radio or 1">
                 <p class="mt-2 text-xs text-gray-500">Find this in your AzuraCast station profile. It's often called the "Station Shortcode".</p>
            </div>
            <button id="saveConfig" class="mt-6 w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                Start Player
            </button>
        </div>
    </div>

    <!-- Main Player -->
    <div class="player-card text-white rounded-2xl p-6 md:p-8 w-full max-w-4xl opacity-0 transition-opacity duration-500" id="player-container">
        <header class="mb-6">
            <div id="logo-container" class="w-24 h-8 border-2 border-dashed border-white/50 flex items-center justify-center">
                 <span class="text-white/50 text-sm">Your Logo</span>
            </div>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="w-full">
                <img id="albumArt" src="https://placehold.co/400x400/1a1a1a/ffffff?text=Loading..." alt="Album Art" class="rounded-lg shadow-lg w-full aspect-square object-cover">
            </div>

            <div class="flex flex-col justify-center">
                <h1 id="mainTitle" class="text-4xl md:text-5xl lg:text-6xl font-black uppercase tracking-wide">SAFE4WORK</h1>
                <p id="stationName" class="text-xl md:text-2xl text-white/80 mt-1">Loading Station...</p>
                <hr class="border-white/20 my-6">

                <div class="flex flex-col">
                    <p id="nowPlayingArtist" class="text-2xl md:text-3xl font-bold">Loading Artist...</p>
                    <p id="nowPlayingTitle" class="text-2xl md:text-3xl text-white/70">Loading Title...</p>
                </div>
                
                <div class="mt-8 flex flex-col gap-4">
                    <div class="flex items-center gap-4">
                        <button id="playBtn" class="play-button-wrapper" disabled>
                            <svg class="play-icon h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                            <svg class="pause-icon h-8 w-8 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm3 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd" /></svg>
                        </button>
                        <div class="flex-grow flex items-center gap-4 bg-black/10 p-2 rounded-full">
                           <div id="visualizerToggleBtn" class="p-2 cursor-pointer rounded-full hover:bg-white/20 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l11 13H9z" />
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 19V6l11 13H5z" opacity="0.5"/>
                                </svg>
                           </div>
                           <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
                        </div>
                    </div>
                    <canvas id="visualizer" class="w-full" height="80"></canvas>
                </div>
            </div>
        </main>
    </div>

    <audio id="audioStream" crossorigin="anonymous" preload="none"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const configModal = document.getElementById('configModal');
            const saveConfigBtn = document.getElementById('saveConfig');
            const azuraUrlInput = document.getElementById('azuraUrl');
            const stationIdInput = document.getElementById('stationId');
            const playerContainer = document.getElementById('player-container');
            const offlineContainer = document.getElementById('offline-container');
            const stationName = document.getElementById('stationName');
            const albumArt = document.getElementById('albumArt');
            const nowPlayingArtist = document.getElementById('nowPlayingArtist');
            const nowPlayingTitle = document.getElementById('nowPlayingTitle');
            const playBtn = document.getElementById('playBtn');
            const playIcon = playBtn.querySelector('.play-icon');
            const pauseIcon = playBtn.querySelector('.pause-icon');
            const audioStream = document.getElementById('audioStream');
            const volumeSlider = document.getElementById('volumeSlider');
            const visualizerToggleBtn = document.getElementById('visualizerToggleBtn');
            const canvas = document.getElementById('visualizer');
            const canvasCtx = canvas.getContext('2d');
            
            let audioContext, analyser, source, animationFrameId;
            let AZURA_URL = '', STATION_ID = '', currentStreamUrl = '';
            let isVisualizerOn = true;

            function startVisualizer() {
                if (!isVisualizerOn || animationFrameId || !analyser) return;
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                function draw() {
                    animationFrameId = requestAnimationFrame(draw);
                    analyser.getByteFrequencyData(dataArray);
                    canvasCtx.fillStyle = '#A30000';
                    canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
                    const barWidth = (canvas.width / bufferLength) * 1.5;
                    let x = 0;
                    const gradient = canvasCtx.createLinearGradient(0, 0, 0, canvas.height);
                    gradient.addColorStop(0, '#ffb8b8');
                    gradient.addColorStop(0.5, '#ffffff');
                    gradient.addColorStop(1, '#ffb8b8');
                    for(let i = 0; i < bufferLength; i++) {
                        const barHeight = dataArray[i] / 2.5;
                        canvasCtx.fillStyle = gradient;
                        canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                        x += barWidth + 2;
                    }
                }
                draw();
            }

            function stopVisualizer() {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                    canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }

            async function fetchNowPlaying() {
                if (!AZURA_URL || !STATION_ID) return;
                try {
                    const apiUrl = `${AZURA_URL}/api/nowplaying/${STATION_ID}`;
                    const response = await fetch(apiUrl, { cache: 'no-store' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (!offlineContainer.classList.contains('hidden')) {
                        offlineContainer.classList.add('hidden');
                        playerContainer.classList.remove('opacity-0');
                    }
                    updatePlayer(data);
                } catch (error) {
                    console.error("Error fetching AzuraCast data:", error);
                    playerContainer.classList.add('opacity-0');
                    offlineContainer.classList.remove('hidden');
                    if (!audioStream.paused) {
                        audioStream.pause();
                        setUiPaused();
                    }
                } finally {
                    setTimeout(fetchNowPlaying, 7000);
                }
            }

            function updatePlayer(data) {
                stationName.textContent = data.station.name || 'Loading...';
                nowPlayingArtist.textContent = data.now_playing.song.artist || 'Unknown Artist';
                
                const titleText = data.now_playing.song.title || 'Unknown Title';
                nowPlayingTitle.textContent = titleText;

                // Show "Advertisement" badge if title indicates sponsored content
                if (titleText.toLowerCase().includes('sponsored content')) {
                    const badge = document.createElement('span');
                    badge.className = 'ad-badge';
                    badge.textContent = 'Advertisement';
                    nowPlayingTitle.appendChild(badge);
                }

                albumArt.src = data.now_playing.song.art || 'https://placehold.co/400x400/1a1a1a/ffffff?text=No+Art';
                const listenUrl = data.station.listen_url;
                if (listenUrl && listenUrl !== currentStreamUrl) {
                    currentStreamUrl = listenUrl;
                    audioStream.src = currentStreamUrl;
                }
                if(currentStreamUrl) {
                    playBtn.disabled = false;
                }
            }

            function setUiPlaying() {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            }
            function setUiPaused() {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }

            async function togglePlay() {
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        analyser = audioContext.createAnalyser();
                        source = audioContext.createMediaElementSource(audioStream);
                        source.connect(analyser);
                        analyser.connect(audioContext.destination);
                    } catch(e) {
                        console.error('Web Audio API not supported.', e);
                        visualizerToggleBtn.style.display = 'none';
                        canvas.style.display = 'none';
                        isVisualizerOn = false;
                    }
                }
                if (audioContext.state === 'suspended') await audioContext.resume();
                if (audioStream.paused) {
                    try {
                        await audioStream.play();
                        setUiPlaying();
                        startVisualizer();
                    } catch (e) { console.error("Error playing audio:", e); }
                } else {
                    audioStream.pause();
                    setUiPaused();
                    stopVisualizer();
                }
            }

            function startPlayer() {
                configModal.style.display = 'none';
                playerContainer.classList.remove('opacity-0');
                fetchNowPlaying();
            }

            playBtn.addEventListener('click', togglePlay);
            volumeSlider.addEventListener('input', e => audioStream.volume = e.target.value);
            visualizerToggleBtn.addEventListener('click', () => {
                isVisualizerOn = !isVisualizerOn;
                visualizerToggleBtn.classList.toggle('bg-white/20', isVisualizerOn);
                if (isVisualizerOn && !audioStream.paused) startVisualizer();
                else stopVisualizer();
            });

            saveConfigBtn.addEventListener('click', () => {
                let url = azuraUrlInput.value.trim();
                const station = stationIdInput.value.trim();
                if (url && station) {
                    if (url.endsWith('/')) url = url.slice(0, -1);
                    AZURA_URL = url;
                    STATION_ID = station;
                    localStorage.setItem('azuraUrl', AZURA_URL);
                    localStorage.setItem('stationId', STATION_ID);
                    startPlayer();
                } else {
                    const tempAlert = document.createElement('div');
                    tempAlert.textContent = 'Please fill in both fields.';
                    tempAlert.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:white;color:black;padding:10px 20px;border-radius:8px;z-index:100;';
                    document.body.appendChild(tempAlert);
                    setTimeout(() => tempAlert.remove(), 3000);
                }
            });

            const savedUrl = localStorage.getItem('azuraUrl');
            const savedStationId = localStorage.getItem('stationId');
            if (savedUrl && savedStationId) {
                AZURA_URL = savedUrl;
                STATION_ID = savedStationId;
               
