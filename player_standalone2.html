<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MMG Radio — Radio Player</title>
  <link rel="icon" type="image/x-icon" href="ff78787f-897f-48f9-9be3-2cd061ddb51f.png"> 
  <style>
    :root{
      --bg:#0b0f17;
      --card:#0f1720;
      --accent:#ff2d95;
      --muted:#9aa6b2;
      --glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1200px 500px at 10% 10%, rgba(255,45,149,0.07), transparent),
                  linear-gradient(180deg, #07101a 0%, #061018 100%);
      color:#e6eef6;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      padding:24px;
    }

    .player {
      width:100%;
      max-width:920px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
      overflow:hidden;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      padding:18px;
      align-items:center;
    }

    .cover {
      width:100%;
      aspect-ratio:1/1;
      border-radius:10px;
      overflow:hidden;
      background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }

    .cover img {
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .live-badge {
      position:absolute;
      left:12px;
      top:12px;
      background:linear-gradient(90deg,var(--accent), #ff7ab9);
      color:white;
      font-weight:600;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      display:flex;
      gap:8px;
      align-items:center;
      box-shadow: 0 6px 18px rgba(255,45,149,0.12);
    }

    .meta {
      display:flex;
      flex-direction:column;
      gap:6px;
      padding-right:10px;
    }

    .station-title {
      font-weight:700;
      font-size:18px;
      letter-spacing:0.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .song-title {
      font-size:20px;
      font-weight:700;
      margin-top:6px;
    }

    .artist {
      color:var(--muted);
      font-size:15px;
      margin-top:2px;
      word-break:break-word;
    }

    .dj {
      margin-top:8px;
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .controls {
      margin-top:12px;
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .play-btn,
    .request-btn {
      background: linear-gradient(90deg,var(--accent), #ff7ab9);
      border:0;
      color:white;
      padding:14px 18px;
      border-radius:12px;
      font-weight:700;
      font-size:16px;
      cursor:pointer;
      display:inline-flex;
      gap:10px;
      align-items:center;
      box-shadow:0 8px 30px rgba(255,45,149,0.12);
      user-select:none;
      transition: background 0.3s;
    }
    .play-btn.paused {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.06);
      color:var(--accent);
      box-shadow:none;
    }
    .play-btn:hover,
    .request-btn:hover {
      filter: brightness(1.1);
    }

    .secondary {
      background:var(--glass);
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      color:var(--muted);
      display:inline-flex;
      gap:10px;
      align-items:center;
    }

    /* Added volume slider styling */
    #volumeContainer {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 13px;
    }
    #volumeSlider {
      -webkit-appearance: none;
      width: 100px;
      height: 5px;
      background: var(--glass);
      border-radius: 5px;
      cursor: pointer;
    }
    #volumeSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      margin-top: -6px;
      box-shadow: 0 0 5px rgba(255, 45, 149, 0.5);
      transition: background 0.3s ease;
    }
    #volumeSlider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 5px rgba(255, 45, 149, 0.5);
      transition: background 0.3s ease;
    }

    .visualizer {
      width:100%;
      height:120px;
      margin-top:16px;
      border-radius:8px;
      overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.02);
      display:block;
    }

    .right-col {
      display:flex;
      flex-direction:column;
      padding-bottom:4px;
    }

    .meta small {
      color:var(--muted);
      display:block;
      margin-top:4px;
    }

    .fallback {
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(255,255,255,0.04);
      font-weight:800;
      font-size:46px;
      letter-spacing:2px;
      width:100%;
      height:100%;
      background:linear-gradient(135deg, rgba(0,0,0,0.15), rgba(255,255,255,0.02));
    }

    @media (max-width:740px){
      .player { grid-template-columns: 1fr; max-width:720px; padding:16px; gap:12px; }
      .cover { order:1; }
      .right-col { order:2; }
    }

    .muted-note {
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }

    .small {
      font-size:13px;
      color:var(--muted);
    }

    .listen-link {
      color:#cfe8ff;
      text-decoration:none;
      border-bottom:1px dashed rgba(255,255,255,0.06);
    }

    /* Popup overlay */
    #requestPopupOverlay {
      position: fixed;
      top: 0; left: 0; bottom: 0; right: 0;
      background: rgba(11, 15, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #requestPopupIframe {
      width: 90vw;
      max-width: 600px;
      height: 80vh;
      border: none;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(255,45,149,0.3);
      background: #0f1720;
    }
    #requestPopupClose {
      position: absolute;
      top: 15px;
      right: 20px;
      background: var(--accent);
      border-radius: 50%;
      width: 28px;
      height: 28px;
      color: white;
      font-weight: 700;
      font-size: 20px;
      line-height: 28px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255,45,149,0.5);
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="player" id="player">
    <div class="cover" id="cover">
      <div class="fallback" id="fallbackArt">MMG</div>
      <div class="live-badge" id="liveBadge" style="display:none;">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden>
          <circle cx="12" cy="12" r="6" fill="white"></circle>
        </svg>
        LIVE
      </div>
    </div>

    <div class="right-col">
      <div class="meta">
        <div class="station-title">
          <img src="" id="stationLogo" alt="" style="width:34px;height:34px;border-radius:6px;display:none;object-fit:cover;">
          <span id="stationName">MMG Radio</span>
        </div>

        <div class="song-title" id="songTitle">—</div>
        <div class="artist" id="artist">—</div>

        <div class="dj" id="djRow" style="display:none;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden>
            <path d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4zM6 20v-1c0-2.76 3.58-5 8-5s8 2.24 8 5v1H6z" fill="currentColor" opacity="0.7"/>
          </svg>
          <div>
            <div style="font-weight:600" id="djName">—</div>
            <div class="small" id="djWhen" style="display:none;">On air now</div>
          </div>
        </div>

        <div class="controls">
          <button class="play-btn paused" id="playBtn" aria-pressed="false" title="Start/Stop">
            <svg id="playIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden>
              <path d="M8 5v14l11-7z" fill="currentColor"></path>
            </svg>
            Start
          </button>

          <button class="request-btn" id="requestBtn" aria-haspopup="dialog" title="Send Song Request">
            Request Song
          </button>

          <a id="listenLink" class="secondary small" href="#" target="_blank" rel="noopener" style="text-decoration:none; color:inherit;">Open stream</a>

          <div id="volumeContainer" title="Volume" aria-label="Volume control">
            <label for="volumeSlider">Vol</label>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" aria-valuemin="0" aria-valuemax="1" aria-valuenow="1" aria-valuetext="Volume 100%" />
          </div>
        </div>

        <canvas class="visualizer" id="visualizer"></canvas>

        <div class="muted-note">If audio doesn't play, open the "Open stream" link.</div>
      </div>
    </div>
  </div>

  <!-- Hidden audio element -->
  <audio id="audio" crossorigin="anonymous" preload="none"></audio>

  <!-- Request popup overlay -->
  <div id="requestPopupOverlay" role="dialog" aria-modal="true" aria-labelledby="requestPopupTitle">
    <div id="requestPopupClose" aria-label="Close request popup" role="button" tabindex="0">&times;</div>
    <iframe src="request.html" id="requestPopupIframe" title="Song Request Form"></iframe>
  </div>

  <script>
    (function(){
      const API = 'https://azura.typicalmedia.net/api/nowplaying/mmg_radio';
      const pollInterval = 5000; // Poll every 5 seconds
      const audio = document.getElementById('audio');
      const playBtn = document.getElementById('playBtn');
      const coverEl = document.getElementById('cover');
      const fallbackArt = document.getElementById('fallbackArt');
      const songTitle = document.getElementById('songTitle');
      const artistEl = document.getElementById('artist');
      const djRow = document.getElementById('djRow');
      const djName = document.getElementById('djName');
      const djWhen = document.getElementById('djWhen');
      const liveBadge = document.getElementById('liveBadge');
      const stationNameEl = document.getElementById('stationName');
      const stationLogo = document.getElementById('stationLogo');
      const listenLink = document.getElementById('listenLink');
      const visualizerCanvas = document.getElementById('visualizer');
      const requestBtn = document.getElementById('requestBtn');
      const requestPopupOverlay = document.getElementById('requestPopupOverlay');
      const requestPopupClose = document.getElementById('requestPopupClose');
      const volumeSlider = document.getElementById('volumeSlider');

      let currentArtUrl = null;
      let currentStreamUrl = null;
      let pollingTimer = null;
      let audioCtx, analyzer, sourceNode;
      let animationId;
      let isAttemptingRestart = false;

      function get(obj, path, fallback = undefined){
        if(!obj) return fallback;
        return path.split('.').reduce((o, p) => (o && o[p] !== undefined) ? o[p] : undefined, obj) || fallback;
      }

      async function fetchNowPlaying(){
        try {
          const res = await fetch(API, {cache: 'no-cache'});
          if(!res.ok) throw new Error('API response ' + res.status);
          const data = await res.json();
          applyNowPlaying(data);
        } catch(err) {
          console.warn('Now playing fetch failed', err);
        } finally {
          schedulePoll();
        }
      }

      function schedulePoll(){
        clearTimeout(pollingTimer);
        pollingTimer = setTimeout(fetchNowPlaying, pollInterval);
      }

      function sanitizeUrl(url){
        if(!url) return null;
        try {
          return new URL(url, window.location.href).href;
        } catch(e){ return url; }
      }

      function applyNowPlaying(data){
        const stationName = get(data, 'station.name') || get(data, 'station.title') || 'BLAZE STREETZ';
        stationNameEl.textContent = stationName;

        const title = get(data, 'now_playing.song.title') || get(data, 'now_playing.song.name') || get(data, 'now_playing.song') || '—';
        const artist = get(data, 'now_playing.song.artist') || get(data, 'now_playing.song.subtitle') || '—';

        songTitle.textContent = title;
        artistEl.textContent = artist;

        let art = get(data, 'now_playing.song.art') || get(data, 'now_playing.song.thumbnail') || get(data, 'now_playing.song.album_art') || get(data, 'station.media.art') || null;
        art = sanitizeUrl(art);

        if(art && art !== currentArtUrl){
          currentArtUrl = art;
          setCoverImage(art);
        } else if(!art){
          removeCoverImage();
        }

        // Use updated live info structure:
        const liveData = get(data, 'live') || {};
        const apiIsLive = Boolean(liveData.is_live);
        const streamerName = liveData.streamer_name || null;

        // DJ detection fallback:
        let dj = get(data, 'now_playing.dj') || get(data, 'now_playing.presenter') || get(data, 'now_playing.song.custom_fields.dj') || get(data, 'source') || null;
        if(!dj){
          const meta = get(data, 'now_playing.song.meta') || get(data, 'now_playing.song.custom_fields') || [];
          if(Array.isArray(meta)){
            for(const m of meta){
              if((m.name && /dj|presenter|host/i.test(m.name)) || (m.key && /dj|presenter|host/i.test(m.key))){
                dj = m.value || m.text || m.data || m.key;
                break;
              }
            }
          } else if (meta && typeof meta === 'object'){
            for(const k of Object.keys(meta)){
              if(/dj|presenter|host/i.test(k)){
                dj = meta[k];
                break;
              }
            }
          }
        }

        if(apiIsLive && streamerName){
          dj = streamerName; // override DJ with live streamer_name
        }

        if(dj){
          djRow.style.display = 'flex';
          djName.textContent = (typeof dj === 'string') ? dj : JSON.stringify(dj);
          if(apiIsLive){
            djWhen.style.display = 'block';
            djWhen.textContent = 'On air now';
          } else {
            djWhen.style.display = 'none';
          }
        } else {
          djRow.style.display = 'none';
        }

        // Show/hide live badge
        const isLive =
          apiIsLive ||
          Boolean(get(data, 'now_playing.live')) ||
          get(data, 'now_playing.source') === 'remote' ||
          Boolean(get(data, 'now_playing.live_stream'));
        liveBadge.style.display = isLive ? 'flex' : 'none';

        const logo = get(data, 'station.logo') || get(data, 'station.media.logo') || null;
        if(logo){
          stationLogo.src = sanitizeUrl(logo);
          stationLogo.style.display = 'inline-block';
        } else {
          stationLogo.style.display = 'none';
        }

        const streamCandidates = [
          get(data, 'station.listen_url'),
          get(data, 'station.stream_url'),
          get(data, 'station.url'),
          get(data, 'station.streams.0.url'),
          get(data, 'listen_url'),
          get(data, 'data.stream_url'),
          get(data, 'now_playing.stream.url')
        ];
        const streamUrl = sanitizeUrl(streamCandidates.find(Boolean) || null);

        if(streamUrl && streamUrl !== currentStreamUrl){
          currentStreamUrl = streamUrl;
          audio.src = currentStreamUrl;
          listenLink.href = currentStreamUrl;
          listenLink.style.display = 'inline-flex';
          listenLink.textContent = 'Open stream';
          // If playing, auto-restart with new stream
          if(!audio.paused){
            isAttemptingRestart = true;
            audio.pause();
            audio.load(); // reload stream
            // play() will be triggered on 'canplay' below
          }
        } else if(!streamUrl){
          const stationUrl = get(data, 'station.url') || get(data, 'station.listen_url') || null;
          listenLink.href = stationUrl || '#';
          listenLink.style.display = 'inline-flex';
          listenLink.textContent = stationUrl ? 'Open station page' : 'Open stream';
        }
      }

      function setCoverImage(url){
        removeCoverImage();
        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Album art';
        img.onload = () => {
          fallbackArt.style.display = 'none';
        };
        img.onerror = () => {
          removeCoverImage();
        };
        img.id = 'coverImg';
        coverEl.appendChild(img);
      }

      function removeCoverImage(){
        const existing = document.getElementById('coverImg');
        if(existing) existing.remove();
        fallbackArt.style.display = 'flex';
        currentArtUrl = null;
      }

      // Play button toggles start/stop with label updated to "Start" or "Stop"
      playBtn.addEventListener('click', async function(){
        if(audio.paused){
          try {
            if(!audioCtx){
              audioCtx = new (window.AudioContext || window.webkitAudioContext)();
              analyzer = audioCtx.createAnalyser();
              analyzer.fftSize = 256;
              sourceNode = audioCtx.createMediaElementSource(audio);
              sourceNode.connect(analyzer);
              analyzer.connect(audioCtx.destination);
              startVisualizer();
            } else if (audioCtx.state === 'suspended'){
              await audioCtx.resume();
            }
          } catch(e){
            console.warn('AudioContext failed:', e);
          }

          try {
            await audio.play();
            playBtn.classList.remove('paused');
            playBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M6 6h12v12H6z" fill="currentColor"/></svg> Stop';
            playBtn.setAttribute('aria-pressed','true');
          } catch(err){
            console.warn('Playback error:', err);
            alert('Unable to start playback. Please open the stream link or check CORS/stream availability.');
          }
        } else {
          // Stop pressed: pause, but keep stream src loaded so it stays live behind the scenes
          audio.pause();
          playBtn.classList.add('paused');
          playBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M8 5v14l11-7z" fill="currentColor"/></svg> Start';
          playBtn.setAttribute('aria-pressed','false');
        }
      });

      // Handle volume slider
      volumeSlider.addEventListener('input', e => {
        const vol = parseFloat(e.target.value);
        audio.volume = vol;
        volumeSlider.setAttribute('aria-valuenow', vol);
        volumeSlider.setAttribute('aria-valuetext', `Volume ${(vol*100).toFixed(0)}%`);
      });

      // Set initial volume to 1
      audio.volume = 1;

      // Restart the audio element if stream stops/errors while playing
      audio.addEventListener('ended', () => {
        if (!audio.paused) {
          restartStream();
        }
      });
      audio.addEventListener('error', () => {
        if (!audio.paused) {
          restartStream();
        }
      });
      audio.addEventListener('stalled', () => {
        if (!audio.paused) {
          restartStream();
        }
      });

      audio.addEventListener('canplay', async () => {
        if (isAttemptingRestart) {
          try {
            await audio.play();
            isAttemptingRestart = false;
          } catch(e) {
            console.warn('Restart playback failed:', e);
          }
        }
      });

      function restartStream(){
        if(isAttemptingRestart) return;
        isAttemptingRestart = true;
        audio.pause();
        audio.load();
      }

      function startVisualizer(){
        const canvas = visualizerCanvas;
        const ctx = canvas.getContext('2d');
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function resizeCanvas(){
          const dpr = window.devicePixelRatio || 1;
          canvas.width = canvas.clientWidth * dpr;
          canvas.height = canvas.clientHeight * dpr;
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        function render(){
          if(!analyzer) return;
          const bufferLength = analyzer.frequencyBinCount;
          const dataArray = new Uint8Array(bufferLength);
          analyzer.getByteFrequencyData(dataArray);
          ctx.clearRect(0,0,canvas.clientWidth, canvas.clientHeight);
          const barWidth = Math.max(2, (canvas.clientWidth / bufferLength) * 1.8);
          let x = 0;
          for(let i=0;i<bufferLength;i+=Math.round(bufferLength/48)){
            const v = dataArray[i] / 255;
            const barHeight = v * canvas.clientHeight;
            const hue = 320 - (v * 120);
            ctx.fillStyle = `hsl(${hue}, 90%, ${50 - v*12}%)`;
            ctx.fillRect(x, canvas.clientHeight - barHeight, barWidth, barHeight);
            x += barWidth + 1;
          }
          animationId = requestAnimationFrame(render);
        }
        cancelAnimationFrame(animationId);
        render();
      }

      // Request popup handlers
      requestBtn.addEventListener('click', () => {
        requestPopupOverlay.style.display = 'flex';
      });
      requestPopupClose.addEventListener('click', () => {
        requestPopupOverlay.style.display = 'none';
      });
      requestPopupOverlay.addEventListener('click', e => {
        if(e.target === requestPopupOverlay){
          requestPopupOverlay.style.display = 'none';
        }
      });
      requestPopupClose.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          requestPopupOverlay.style.display = 'none';
        }
      });

      fetchNowPlaying();

      document.addEventListener('visibilitychange', () => {
        if(document.hidden){
          if(audioCtx && audioCtx.state === 'running') audioCtx.suspend();
          cancelAnimationFrame(animationId);
        } else {
          if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        }
      });

      window.addEventListener('beforeunload', () => {
        if(animationId) cancelAnimationFrame(animationId);
        if(pollingTimer) clearTimeout(pollingTimer);
        try { if(audioCtx) audioCtx.close(); } catch(e){}
      });
    })();
  </script>
</body>
</html>