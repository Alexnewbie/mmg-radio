<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MMG Radio — Radio Player</title>
  <link rel="icon" href="/logo.svg" />
  <style>
    /* --- Extra styling for badge, DJ row, fallback --- */
    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(90deg, #ef4444, #f97316);
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 9999px;
    }
    .dj-row {
      margin-top: 6px;
      font-size: 13px;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .fallback-note {
      margin-top: 8px;
      font-size: 13px;
      color: #f87171;
      display: none;
    }
    .visualizer {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      margin-top: 12px;
      background: rgba(255,255,255,0.03);
    }
    #requestPopupOverlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #requestPopupCard {
      width: 90%;
      max-width: 600px;
      height: 70vh;
      background: #111827;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }
    #requestPopupClose {
      position: absolute;
      top: 10px; right: 10px;
      width: 28px; height: 28px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      font-weight: bold;
      text-align: center;
      line-height: 28px;
      cursor: pointer;
    }
    #requestIframe { width:100%; height:100%; border:0; }
  </style>
</head>
<body class="bg-neutral-950 text-neutral-100 selection:bg-brand-400/40">
  <!-- Sticky Audio Bar -->
  <div id="audioBar" class="fixed bottom-3 left-1/2 -translate-x-1/2 z-50 w-[min(1100px,95vw)]">
    <div class="bg-neutral-900/90 backdrop-blur border border-neutral-800 rounded-2xl p-3 shadow-2xl shadow-black/50">
      <div class="flex items-center gap-3">
        <button id="playBtn" class="h-11 w-11 rounded-full bg-brand-500 hover:bg-brand-400 grid place-items-center" aria-label="Play/Pause">
          <svg id="iconPlay" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3l14 9-14 9V3z"/></svg>
          <svg id="iconPause" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6"/></svg>
        </button>
        <div class="min-w-0 flex-1">
          <div class="text-sm text-neutral-400">Now Playing</div>
          <div id="nowTitle" class="truncate font-semibold">—</div>
        </div>
        <label class="flex items-center gap-2 text-xs text-neutral-400" for="volume">
          Vol
          <input id="volume" type="range" min="0" max="1" step="0.01" class="w-28 accent-brand-500" value="0.7">
        </label>
        <a id="listenBtn" href="#" target="_blank" class="hidden sm:inline-flex text-sm bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 rounded-xl px-3 py-2">Open Stream</a>
      </div>
      <audio id="player" preload="none" crossorigin="anonymous"></audio>
    </div>
  </div>

  <!-- Hero -->
  <section id="live" class="relative overflow-hidden">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 pt-20 pb-28">
      <h1 class="text-4xl font-extrabold">Music &amp; Talk That Moves Your City</h1>
    </div>
  </section>

  <!-- Now Playing -->
  <section class="mx-auto max-w-6xl px-4 sm:px-6 py-12">
    <div class="grid md:grid-cols-[120px,1fr] gap-6 items-center">
      <div class="aspect-square rounded-2xl overflow-hidden bg-neutral-800">
        <img id="nowArt" src="/artwork.jpg" alt="Now playing artwork" class="h-full w-full object-cover">
      </div>
      <div>
        <h2 class="text-2xl font-bold flex items-center gap-3">
          On Air <span id="liveBadge" class="live-badge hidden">LIVE</span>
        </h2>
        <p id="nowArtist" class="mt-2 text-neutral-400">—</p>
        <p id="nowTrack" class="text-lg font-semibold">—</p>
        <p id="djRow" class="dj-row hidden"><strong id="djName">DJ</strong></p>
        <p id="fallbackMsg" class="fallback-note">⚠️ Playback blocked — use the "Open Stream" link above.</p>
        <div class="mt-4 flex gap-3">
          <button id="requestBtn" class="text-sm bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 rounded-xl px-3 py-2">Request Song</button>
        </div>
        <canvas id="visualizer" class="visualizer"></canvas>
      </div>
    </div>
  </section>

  <!-- Request popup -->
  <div id="requestPopupOverlay">
    <div id="requestPopupCard">
      <div id="requestPopupClose">&times;</div>
      <iframe id="requestIframe" src="request.html" title="Song Request Form"></iframe>
    </div>
  </div>

<script>
const API = 'https://azura.typicalmedia.net/api/nowplaying/mmg_radio';
const player = document.getElementById('player');
const playBtn = document.getElementById('playBtn');
const iconPlay = document.getElementById('iconPlay');
const iconPause = document.getElementById('iconPause');
const volume = document.getElementById('volume');
const nowTitle = document.getElementById('nowTitle');
const nowArtist = document.getElementById('nowArtist');
const nowTrack = document.getElementById('nowTrack');
const nowArt = document.getElementById('nowArt');
const liveBadge = document.getElementById('liveBadge');
const djRow = document.getElementById('djRow');
const djName = document.getElementById('djName');
const fallbackMsg = document.getElementById('fallbackMsg');
const listenBtn = document.getElementById('listenBtn');
const requestBtn = document.getElementById('requestBtn');
const requestPopupOverlay = document.getElementById('requestPopupOverlay');
const requestPopupClose = document.getElementById('requestPopupClose');
const visualizer = document.getElementById('visualizer');

let currentStream=null, audioCtx, analyzer, sourceNode, animationId;

function setPlayingUI(isPlaying){
  iconPlay.classList.toggle('hidden', isPlaying);
  iconPause.classList.toggle('hidden', !isPlaying);
}
playBtn.onclick=async()=>{
  if(player.paused){
    try{
      if(!audioCtx){
        audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        analyzer=audioCtx.createAnalyser();analyzer.fftSize=256;
        sourceNode=audioCtx.createMediaElementSource(player);
        sourceNode.connect(analyzer);analyzer.connect(audioCtx.destination);
        startVisualizer();
      } else if(audioCtx.state==='suspended'){await audioCtx.resume();}
      await player.play();setPlayingUI(true);fallbackMsg.style.display='none';
    }catch(e){console.warn(e);fallbackMsg.style.display='block';}
  } else {player.pause();setPlayingUI(false);}
};
volume.oninput=e=>player.volume=parseFloat(e.target.value);

requestBtn.onclick=()=>{requestPopupOverlay.style.display='flex';};
requestPopupClose.onclick=()=>{requestPopupOverlay.style.display='none';};
requestPopupOverlay.onclick=e=>{if(e.target===requestPopupOverlay)requestPopupOverlay.style.display='none';};

function get(obj,path,fallback){return path.split('.').reduce((o,p)=>o?o[p]:undefined,obj)||fallback;}
function sanitizeUrl(url){try{return new URL(url,location.href).href}catch{return url}}

async function fetchNow(){
  try{
    let res=await fetch(API,{cache:'no-store'}),data=await res.json();
    nowTitle.textContent=get(data,'station.name','MMG Radio');
    nowTrack.textContent=get(data,'now_playing.song.title','—');
    nowArtist.textContent=get(data,'now_playing.song.artist','—');
    let art=get(data,'now_playing.song.art')||get(data,'station.media.art'); if(art) nowArt.src=sanitizeUrl(art);
    let dj=get(data,'live.streamer_name')||get(data,'now_playing.dj'); 
    if(dj){djRow.classList.remove('hidden');djName.textContent=dj;} else djRow.classList.add('hidden');
    liveBadge.classList.toggle('hidden',!get(data,'live.is_live'));
    let stream=get(data,'station.listen_url'); 
    if(stream && stream!==currentStream){currentStream=stream;player.src=currentStream;listenBtn.href=currentStream;listenBtn.classList.remove('hidden');}
  }catch(e){console.warn('API error',e);}
  setTimeout(fetchNow,7000);
}
function startVisualizer(){
  let ctx=visualizer.getContext('2d');
  function draw(){
    requestAnimationFrame(draw);
    let arr=new Uint8Array(analyzer.frequencyBinCount);
    analyzer.getByteFrequencyData(arr);
    ctx.clearRect(0,0,visualizer.width,visualizer.height);
    let barWidth=visualizer.width/arr.length*2,x=0;
    arr.forEach(v=>{
      let h=v/255*visualizer.height;
      ctx.fillStyle=`hsl(${300-v/2},80%,50%)`;
      ctx.fillRect(x,visualizer.height-h,barWidth,h);
      x+=barWidth+1;
    });
  } draw();
}
fetchNow();
</script>
</body>
</html>
